# Take-off Pro - Complete Migration Files
Date: March 12, 2025

This document contains all the files needed to set up the Take-off Pro application in a new Replit project. Copy this entire content and paste it into your new project's chat.

## Initial Setup Commands
```bash
# Create directory structure
mkdir -p client/src/{components,lib,pages} server/routes shared public

# Install dependencies
npm install @vitejs/plugin-react vite express cors @tanstack/react-query wouter react react-dom @hookform/resolvers zod drizzle-orm drizzle-zod multer @tanstack/react-query-devtools lucide-react @radix-ui/react-dialog @radix-ui/react-dropdown-menu @radix-ui/react-tooltip
```

## Required Environment Variables
```env
PORT=5000
NODE_ENV=development
VITE_API_URL=http://localhost:5000
VITE_ALLOWED_HOSTS=all
```

## Core Files

### 1. server/index.ts
```typescript
import express from "express";
import { createServer } from "http";
import { registerRoutes } from "./routes";
import { setupVite } from "./vite";
import cors from "cors";
import { performHealthCheck } from "./health-check";

const app = express();
const httpServer = createServer(app);
const PORT = process.env.PORT || 5000;

// Basic middleware setup
app.use(express.json());
app.use(cors({
  origin: true,
  credentials: true
}));

// Register API routes
registerRoutes(app);

// Health check endpoint
app.get('/api/health', async (req, res) => {
  const healthCheck = await performHealthCheck();
  res.json(healthCheck);
});

async function startServer() {
  try {
    console.log('Starting API server...');
    await setupVite(app, httpServer);
    httpServer.listen(PORT, "0.0.0.0", () => {
      console.log(`Server running on port ${PORT}`);
    });
  } catch (error) {
    console.error('Failed to start server:', error);
    process.exit(1);
  }
}

startServer();
```

### 2. server/vite.ts
```typescript
import { createServer } from 'http';
import { ViteDevServer } from 'vite';
import express from 'express';

export async function setupVite(app: express.Express, server: createServer) {
    const vite = await import('vite');
    const viteServer = await vite.createServer({
        server: { 
            middlewareMode: true,
            hmr: {
                server: server,
                clientPort: 443,
                protocol: 'wss'
            },
            host: '0.0.0.0',
            port: 5000,
            strictPort: true,
            allowedHosts: true
        }
    });
    app.use(viteServer.middlewares);
}
```

### 3. server/routes/projects.ts
```typescript
import { Router } from "express";
import { db } from "../db";
import { eq } from "drizzle-orm";
import { 
  projects, 
  insertProjectSchema,
  projectTasks,
  criticalPaths,
  resources,
  resourceAssignments 
} from "@shared/schema";

const router = Router();

// Get all projects with enhanced details
router.get("/", async (_req, res) => {
  try {
    const projectsList = await db
      .select({
        project: projects,
        taskCount: projectTasks,
        criticalTaskCount: criticalPaths,
        resourceCount: resourceAssignments
      })
      .from(projects)
      .leftJoin(projectTasks, eq(projects.id, projectTasks.projectId))
      .leftJoin(criticalPaths, eq(projects.id, criticalPaths.projectId))
      .leftJoin(resourceAssignments, eq(projectTasks.id, resourceAssignments.taskId));

    // Group and format the results
    const formattedProjects = projectsList.reduce((acc, curr) => {
      if (!acc[curr.project.id]) {
        acc[curr.project.id] = {
          ...curr.project,
          taskCount: 0,
          criticalTaskCount: 0,
          assignedResources: 0
        };
      }
      if (curr.taskCount) acc[curr.project.id].taskCount++;
      if (curr.criticalTaskCount) acc[curr.project.id].criticalTaskCount++;
      if (curr.resourceCount) acc[curr.project.id].assignedResources++;
      return acc;
    }, {} as Record<number, any>);

    res.json(Object.values(formattedProjects));
  } catch (error) {
    console.error("Failed to fetch projects:", error);
    res.status(500).json({
      error: "Failed to fetch projects",
      details: error instanceof Error ? error.message : "Unknown error"
    });
  }
});

export default router;
```

### 4. server/routes/critical-path.ts
```typescript
import { Router } from "express";
import { db } from "../db";
import { eq, and } from "drizzle-orm";
import { 
  projectTasks,
  criticalPaths,
  resources,
  resourceAssignments,
  insertProjectTaskSchema,
  insertCriticalPathSchema,
  insertResourceAssignmentSchema 
} from "@shared/schema";

const router = Router();

// Get all tasks for a project with critical path analysis
router.get("/:projectId", async (req, res) => {
  try {
    const projectId = parseInt(req.params.projectId);
    const tasks = await db
      .select({
        task: projectTasks,
        criticalPath: criticalPaths,
        resources: resourceAssignments
      })
      .from(projectTasks)
      .leftJoin(criticalPaths, eq(projectTasks.id, criticalPaths.taskId))
      .leftJoin(resourceAssignments, eq(projectTasks.id, resourceAssignments.taskId))
      .where(eq(projectTasks.projectId, projectId));

    // Group tasks with their resources and critical path info
    const groupedTasks = tasks.reduce((acc, curr) => {
      if (!acc[curr.task.id]) {
        acc[curr.task.id] = {
          ...curr.task,
          criticalPath: curr.criticalPath,
          resources: []
        };
      }
      if (curr.resources) {
        acc[curr.task.id].resources.push(curr.resources);
      }
      return acc;
    }, {} as Record<number, any>);

    res.json(Object.values(groupedTasks));
  } catch (error) {
    console.error("Failed to fetch critical path:", error);
    res.status(500).json({
      error: "Failed to fetch critical path",
      details: error instanceof Error ? error.message : "Unknown error"
    });
  }
});

export default router;
```

### 5. client/src/App.tsx
```typescript
import { Switch, Route } from "wouter";
import { QueryClientProvider } from "@tanstack/react-query";
import { queryClient } from "./lib/queryClient";
import { Toaster } from "@/components/ui/toaster";

// Page components
import ProjectsPage from "./pages/projects";
import DrawingsPage from "./pages/drawings";
import CostPlanPage from "./pages/projects/cost-plan";
import NotFound from "./pages/not-found";

export default function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <div className="min-h-screen bg-background">
        <Switch>
          <Route path="/" component={ProjectsPage} />
          <Route path="/drawings" component={DrawingsPage} />
          <Route path="/projects/cost-plan" component={CostPlanPage} />
          <Route component={NotFound} />
        </Switch>
      </div>
      <Toaster />
    </QueryClientProvider>
  );
}
```

### 6. client/src/lib/queryClient.ts
```typescript
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:5000';

export async function apiRequest(
  method: string,
  url: string,
  data?: unknown | undefined,
): Promise<Response> {
  const apiUrl = `${API_URL}${url}`;
  const res = await fetch(apiUrl, {
    method,
    headers: data ? { "Content-Type": "application/json" } : {},
    body: data ? JSON.stringify(data) : undefined,
    credentials: "include",
  });
  await throwIfResNotOk(res);
  return res;
}

async function throwIfResNotOk(res: Response) {
  if (!res.ok) {
    const errorData = await res.json();
    const errorMessage = errorData.message || res.statusText;
    throw new Error(errorMessage);
  }
}
```

### 7. tsconfig.json
```json
{
  "include": ["client/src/**/*", "shared/**/*", "server/**/*"],
  "exclude": ["node_modules", "build", "dist", "**/*.test.ts"],
  "compilerOptions": {
    "incremental": true,
    "tsBuildInfoFile": "./node_modules/typescript/tsbuildinfo",
    "noEmit": true,
    "module": "ESNext",
    "strict": true,
    "lib": ["esnext", "dom", "dom.iterable"],
    "jsx": "preserve",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "allowImportingTsExtensions": true,
    "moduleResolution": "bundler",
    "baseUrl": ".",
    "types": ["node", "vite/client"],
    "paths": {
      "@/*": ["./client/src/*"],
      "@shared/*": ["./shared/*"]
    }
  }
}
```

### 8. package.json
```json
{
  "scripts": {
    "dev": "tsx server/index.ts"
  }
}
```

## Post-Setup Steps

1. Create PostgreSQL database:
```typescript
await create_postgresql_database_tool()
```

2. Start the development server:
```bash
npm run dev
```

3. Verify the setup:
- Check server startup at http://localhost:5000/api/health
- Verify frontend loads without host validation errors
- Test API endpoints (/api/projects, /api/critical-path)

Remember to clear your browser cache and restart the development server if you encounter any issues.
